---
layout: post
title: "Swarm"
categories:
  - pt-br
tags:
  - pt-br
  - python
  - docker
  - swarm
featured-img: swarm
last_modified_at: 2019-03-13T23:21:32-05:00
---


# O que é o docker-swarm

Docker swarm é a ferramenta de clusterização. Essa feature já vem junto com a instalação do docker. O swarm tem o objetivo de permitir escalabilidade, service discovery, gerencimento dos clusters integrado com o docker, balanceamento de carga e update gradual.
A aplicação também pode ser dividida em nodes diferentes, sendo possível subir serviço a serviço ou toda uma stack.

# Como Swarm se divide

De maneira grosseira podemos dividir o swarm na seguinte estrutura:

*Swarm*: é o gerenciador. Os Workers, os nodes de gerenciamentos etc. Quando você faz o deploy para o *swarm* ele gerencia tudo, onde e quem deve fazer o que.

*Service*: é o equivalente ao *docker container* do swarm.

*Stack*: é o equivalente ao *docker compose* do swarm.

# Mas quando eu uso?

Isso varia de acordo com o que se espera do container. Todos os exemplos que fizemos até agora são aplicações pequenas, sem altas demandas. Se por ventura existisse a necessidade de escalar a nossa aplicação, as funcionalidades como `compose` e `containerização individual` nos atenderiam até certo ponto, mas utilizando `swarm`, conseguiríamos fazer isso com maior dinamismo e personalização.

# Partiu

Para facilitar esse exemplo vamos usar [Play with docker](https://labs.play-with-docker.com) que é uma ferramenta que permite a criação de nodes para testes com Docker. 

<img src="https://i.imgur.com/qPTzyoI.png" style="height:400px;"/>


Depois de logar e iniciar a sessão, o usuário tem 4 horas para fazer os seus testes, após esse tempo tudo será apagado e o processo deve ser iniciado novamente. Para o nosso cenário isso é perfeito.

Para fazermos os testes com o swarm vamos precisar de 3 nodes. Depois de adicionados, vamos clicar no primeiro node e executar o comando a seguir:

<img src="https://i.imgur.com/0bLKfGK.png" style="height:400px;"/>

```
docker swarm init
```

Se algum erro aparecer ao executar o comando, execute o comando abaixo alterando o campo `IP_DO_NODE_QUE_ESTAMOS_USANDO` para o ip do seu node.

```
docker swarm init --advertise-addr IP_DO_NODE_QUE_ESTAMOS_USANDO
```
<img src="https://i.imgur.com/UHxzNDV.png" style="height:400px;"/>

Apos isso o docker vai gerar uma mensagem dizendo que o node atual é um *gerenciador* e disponibilizará um token para os demais nodes se unirem a esse.

Beleza, mas pra que isso?

Estamos configurando o gerenciador e workers do swarm. O gerenciador é o nosso node de administração, nele executaremos tudo que precisar no nosso swarm, os demais nodes são workers e como o próprio nome já diz, ele serão a nossa mão de obra.

Nesse primeiro node, vamos subir uma instância do mongo e definir uma interface de rede para os nossos serviços.

```
docker network create -d "overlay" nova
```

```
docker service create --name mongo -p 27017:27017 --network "nova" mongo:3.4
```

Vamos subir no node1 a [aplicação que criamos anteriormente](http://cassioroos.com/pt-br/2019/02/10/Docker-compose.html).

```
docker service create --name appdocker --network "nova" -e APP_PORT=5001 -e DB_URL=mongo -e DB_PORTA=27017 -e DB_NOME=hello_world -p 5001:5001 cassioroos/app-docker
```

Para utilizar os demais nodes vamos precisar gerar um token para que eles possam ser administrados pelo nosso manager.

```
docker swarm join-token worker
```

Que resultará em algo parecido com isso:

```
docker swarm join --token SWMTKN-1-2ititjgrai9fsqdnttquxisl5fej5nkyzh31jzdit8rl2e13om-1salrs59jm94cxsnvch3wfil4 192.168.0.23:2377
```

Vamos copiar esse token e colocar nos outros dois nodes. Quando o comando for executado nos nodes a mensagem de confirmação deve aparecer `This node joined a swarm as a worker.`

Finalmente vamos fazer com que o docker use esses nodes `workers`. Vamos subir 3 replicas do nosso serviço `appdocker`. Como somente um de nossos nodes é manager, é por ele que devemos fazer todas as configurações.

```
docker service scale appdocker=3
```

Para executar o get e post via PlayWithDocker é só clicar no link da porta que aparece ao lado do ip do seu node1. Esse endereço pode ser usando no postman da mesma forma que utilizamos anteriormente.

<img src="https://i.imgur.com/yuFvafG.png" style="height:400px;"/>

Como estamos no ambiente gerenciado pelo docker, qualquer request feito para o nossos container, independente do ip que utilizarmos, será direcionado para um node de acordo com o seu balanceamento interno. Se olharmos os logs de cada container em seus nodes, poderemos ver que o node responsável por salvar uma informação não necessariamente irá ser o mesmo que irá retornar a consulta daquela informação.

Para fixação, acho válido brincar com o nosso swarm e utilizar todos os comandos que já vimos.

Como sempre, fico a disposição para qualquer dúvida ou sugestão.
